import{S as tn,i as cn,s as ln,k as sn,l as an,m as dn,h as me,n as ve,b as un,I as Q,o as fn,w as pn}from"./index.4bc3a562.js";const gn=["white","black"],ie=["a","b","c","d","e","f","g","h"],ce=["1","2","3","4","5","6","7","8"],hn=[...ce].reverse(),le=Array.prototype.concat(...ie.map(e=>ce.map(n=>e+n))),C=e=>le[8*e[0]+e[1]],m=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Ae=le.map(m);function mn(e){let n;const o=()=>(n===void 0&&(n=e()),n);return o.clear=()=>{n=void 0},o}const vn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const n=performance.now()-e;return e=void 0,n}}},se=e=>e==="white"?"black":"white",G=(e,n)=>{const o=e[0]-n[0],r=e[1]-n[1];return o*o+r*r},oe=(e,n)=>e.role===n.role&&e.color===n.color,U=e=>(n,o)=>[(o?n[0]:7-n[0])*e.width/8,(o?7-n[1]:n[1])*e.height/8],x=(e,n)=>{e.style.transform=`translate(${n[0]}px,${n[1]}px)`},De=(e,n,o=1)=>{e.style.transform=`translate(${n[0]}px,${n[1]}px) scale(${o})`},ae=(e,n)=>{e.style.visibility=n?"visible":"hidden"},W=e=>{var n;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((n=e.targetTouches)===null||n===void 0)&&n[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},qe=e=>e.buttons===2||e.button===2,D=(e,n)=>{const o=document.createElement(e);return n&&(o.className=n),o};function Oe(e,n,o){const r=m(e);return n||(r[0]=7-r[0],r[1]=7-r[1]),[o.left+o.width*r[0]/8+o.width/16,o.top+o.height*(7-r[1])/8+o.height/16]}const R=(e,n)=>Math.abs(e-n),bn=e=>(n,o,r,t)=>R(n,r)<2&&(e==="white"?t===o+1||o<=1&&t===o+2&&n===r:t===o-1||o>=6&&t===o-2&&n===r),_e=(e,n,o,r)=>{const t=R(e,o),i=R(n,r);return t===1&&i===2||t===2&&i===1},Ke=(e,n,o,r)=>R(e,o)===R(n,r),Ne=(e,n,o,r)=>e===o||n===r,Te=(e,n,o,r)=>Ke(e,n,o,r)||Ne(e,n,o,r),wn=(e,n,o)=>(r,t,i,c)=>R(r,i)<2&&R(t,c)<2||o&&t===c&&t===(e==="white"?0:7)&&(r===4&&(i===2&&n.includes(0)||i===6&&n.includes(7))||n.includes(i));function yn(e,n){const o=n==="white"?"1":"8",r=[];for(const[t,i]of e)t[1]===o&&i.color===n&&i.role==="rook"&&r.push(m(t)[0]);return r}function Ee(e,n,o){const r=e.get(n);if(!r)return[];const t=m(n),i=r.role,c=i==="pawn"?bn(r.color):i==="knight"?_e:i==="bishop"?Ke:i==="rook"?Ne:i==="queen"?Te:wn(r.color,yn(e,r.color),o);return Ae.filter(l=>(t[0]!==l[0]||t[1]!==l[1])&&c(t[0],t[1],l[0],l[1])).map(C)}function b(e,...n){e&&setTimeout(()=>e(...n),1)}function Pn(e){e.orientation=se(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function kn(e,n){for(const[o,r]of n)r?e.pieces.set(o,r):e.pieces.delete(o)}function Sn(e,n){if(e.check=void 0,n===!0&&(n=e.turnColor),n)for(const[o,r]of e.pieces)r.role==="king"&&r.color===n&&(e.check=o)}function Cn(e,n,o,r){T(e),e.premovable.current=[n,o],b(e.premovable.events.set,n,o,r)}function N(e){e.premovable.current&&(e.premovable.current=void 0,b(e.premovable.events.unset))}function Mn(e,n,o){N(e),e.predroppable.current={role:n,key:o},b(e.predroppable.events.set,n,o)}function T(e){const n=e.predroppable;n.current&&(n.current=void 0,b(n.events.unset))}function $n(e,n,o){if(!e.autoCastle)return!1;const r=e.pieces.get(n);if(!r||r.role!=="king")return!1;const t=m(n),i=m(o);if(t[1]!==0&&t[1]!==7||t[1]!==i[1])return!1;t[0]===4&&!e.pieces.has(o)&&(i[0]===6?o=C([7,i[1]]):i[0]===2&&(o=C([0,i[1]])));const c=e.pieces.get(o);return!c||c.color!==r.color||c.role!=="rook"?!1:(e.pieces.delete(n),e.pieces.delete(o),t[0]<i[0]?(e.pieces.set(C([6,i[1]]),r),e.pieces.set(C([5,i[1]]),c)):(e.pieces.set(C([2,i[1]]),r),e.pieces.set(C([3,i[1]]),c)),!0)}function He(e,n,o){const r=e.pieces.get(n),t=e.pieces.get(o);if(n===o||!r)return!1;const i=t&&t.color!==r.color?t:void 0;return o===e.selected&&M(e),b(e.events.move,n,o,i),$n(e,n,o)||(e.pieces.set(o,r),e.pieces.delete(n)),e.lastMove=[n,o],e.check=void 0,b(e.events.change),i||!0}function de(e,n,o,r){if(e.pieces.has(o))if(r)e.pieces.delete(o);else return!1;return b(e.events.dropNewPiece,n,o),e.pieces.set(o,n),e.lastMove=[o],e.check=void 0,b(e.events.change),e.movable.dests=void 0,e.turnColor=se(e.turnColor),!0}function Le(e,n,o){const r=He(e,n,o);return r&&(e.movable.dests=void 0,e.turnColor=se(e.turnColor),e.animation.current=void 0),r}function Re(e,n,o){if(ue(e,n,o)){const r=Le(e,n,o);if(r){const t=e.hold.stop();M(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:t};return r!==!0&&(i.captured=r),b(e.movable.events.after,n,o,i),!0}}else if(An(e,n,o))return Cn(e,n,o,{ctrlKey:e.stats.ctrlKey}),M(e),!0;return M(e),!1}function We(e,n,o,r){const t=e.pieces.get(n);t&&(xn(e,n,o)||r)?(e.pieces.delete(n),de(e,t,o,r),b(e.movable.events.afterNewPiece,t.role,o,{premove:!1,predrop:!1})):t&&Dn(e,n,o)?Mn(e,t.role,o):(N(e),T(e)),e.pieces.delete(n),M(e)}function re(e,n,o){if(b(e.events.select,n),e.selected){if(e.selected===n&&!e.draggable.enabled){M(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==n&&Re(e,e.selected,n)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(ze(e,n)||fe(e,n))&&(Be(e,n),e.hold.start())}function Be(e,n){e.selected=n,fe(e,n)?e.premovable.dests=Ee(e.pieces,n,e.premovable.castle):e.premovable.dests=void 0}function M(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function ze(e,n){const o=e.pieces.get(n);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}const ue=(e,n,o)=>{var r,t;return n!==o&&ze(e,n)&&(e.movable.free||!!(!((t=(r=e.movable.dests)===null||r===void 0?void 0:r.get(n))===null||t===void 0)&&t.includes(o)))};function xn(e,n,o){const r=e.pieces.get(n);return!!r&&(n===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function fe(e,n){const o=e.pieces.get(n);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}const An=(e,n,o)=>n!==o&&fe(e,n)&&Ee(e.pieces,n,e.premovable.castle).includes(o);function Dn(e,n,o){const r=e.pieces.get(n),t=e.pieces.get(o);return!!r&&(!t||t.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function qn(e,n){const o=e.pieces.get(n);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function On(e){const n=e.premovable.current;if(!n)return!1;const o=n[0],r=n[1];let t=!1;if(ue(e,o,r)){const i=Le(e,o,r);if(i){const c={premove:!0};i!==!0&&(c.captured=i),b(e.movable.events.after,o,r,c),t=!0}}return N(e),t}function _n(e,n){const o=e.predroppable.current;let r=!1;if(!o)return!1;if(n(o)){const t={role:o.role,color:e.movable.color};de(e,t,o.key)&&(b(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),r=!0)}return T(e),r}function pe(e){N(e),T(e),M(e)}function be(e){e.movable.color=e.movable.dests=e.animation.current=void 0,pe(e)}function B(e,n,o){let r=Math.floor(8*(e[0]-o.left)/o.width);n||(r=7-r);let t=7-Math.floor(8*(e[1]-o.top)/o.height);return n||(t=7-t),r>=0&&r<8&&t>=0&&t<8?C([r,t]):void 0}function Kn(e,n,o,r){const t=m(e),i=Ae.filter(s=>Te(t[0],t[1],s[0],s[1])||_e(t[0],t[1],s[0],s[1])),l=i.map(s=>Oe(C(s),o,r)).map(s=>G(n,s)),[,a]=l.reduce((s,g,d)=>s[0]<g?s:[g,d],[l[0],0]);return C(i[a])}const w=e=>e.orientation==="white",Fe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Nn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Tn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Ie(e){e==="start"&&(e=Fe);const n=new Map;let o=7,r=0;for(const t of e)switch(t){case" ":case"[":return n;case"/":if(--o,o<0)return n;r=0;break;case"~":{const i=n.get(C([r-1,o]));i&&(i.promoted=!0);break}default:{const i=t.charCodeAt(0);if(i<57)r+=i-48;else{const c=t.toLowerCase();n.set(C([r,o]),{role:Nn[c],color:t===c?"black":"white"}),++r}}}return n}function En(e){return hn.map(n=>ie.map(o=>{const r=e.get(o+n);if(r){let t=Tn[r.role];return r.color==="white"&&(t=t.toUpperCase()),r.promoted&&(t+="~"),t}else return"1"}).join("")).join("/").replace(/1{2,}/g,n=>n.length.toString())}function je(e,n){n.animation&&(ge(e.animation,n.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Ve(e,n){var o,r,t;if(!((o=n.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((r=n.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),ge(e,n),n.fen&&(e.pieces=Ie(n.fen),e.drawable.shapes=((t=n.drawable)===null||t===void 0?void 0:t.shapes)||[]),"check"in n&&Sn(e,n.check||!1),"lastMove"in n&&!n.lastMove?e.lastMove=void 0:n.lastMove&&(e.lastMove=n.lastMove),e.selected&&Be(e,e.selected),je(e,n),!e.movable.rookCastle&&e.movable.dests){const i=e.movable.color==="white"?"1":"8",c="e"+i,l=e.movable.dests.get(c),a=e.pieces.get(c);if(!l||!a||a.role!=="king")return;e.movable.dests.set(c,l.filter(s=>!(s==="a"+i&&l.includes("c"+i))&&!(s==="h"+i&&l.includes("g"+i))))}}function ge(e,n){for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&we(e[o])&&we(n[o])?ge(e[o],n[o]):e[o]=n[o])}function we(e){if(typeof e!="object"||e===null)return!1;const n=Object.getPrototypeOf(e);return n===Object.prototype||n===null}const L=(e,n)=>n.animation.enabled?Rn(e,n):_(e,n);function _(e,n){const o=e(n);return n.dom.redraw(),o}const J=(e,n)=>({key:e,pos:m(e),piece:n}),Hn=(e,n)=>n.sort((o,r)=>G(e.pos,o.pos)-G(e.pos,r.pos))[0];function Ln(e,n){const o=new Map,r=[],t=new Map,i=[],c=[],l=new Map;let a,s,g;for(const[d,v]of e)l.set(d,J(d,v));for(const d of le)a=n.pieces.get(d),s=l.get(d),a?s?oe(a,s.piece)||(i.push(s),c.push(J(d,a))):c.push(J(d,a)):s&&i.push(s);for(const d of c)s=Hn(d,i.filter(v=>oe(d.piece,v.piece))),s&&(g=[s.pos[0]-d.pos[0],s.pos[1]-d.pos[1]],o.set(d.key,g.concat(g)),r.push(s.key));for(const d of i)r.includes(d.key)||t.set(d.key,d.piece);return{anims:o,fadings:t}}function Ze(e,n){const o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(n-o.start)*o.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=Wn(r);for(const i of o.plan.anims.values())i[2]=i[0]*t,i[3]=i[1]*t;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>Ze(e,i))}}function Rn(e,n){const o=new Map(n.pieces),r=e(n),t=Ln(o,n);if(t.anims.size||t.fadings.size){const i=n.animation.current&&n.animation.current.start;n.animation.current={start:performance.now(),frequency:1/n.animation.duration,plan:t},i||Ze(n,performance.now())}else n.dom.redraw();return r}const Wn=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Bn=["green","red","blue","yellow"];function zn(e,n){if(n.touches&&n.touches.length>1)return;n.stopPropagation(),n.preventDefault(),n.ctrlKey?M(e):pe(e);const o=W(n),r=B(o,w(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:o,brush:Vn(n),snapToValidMove:e.drawable.defaultSnapToValidMove},Ge(e))}function Ge(e){requestAnimationFrame(()=>{const n=e.drawable.current;if(n){const o=B(n.pos,w(e),e.dom.bounds());o||(n.snapToValidMove=!1);const r=n.snapToValidMove?Kn(n.orig,n.pos,w(e),e.dom.bounds()):o;r!==n.mouseSq&&(n.mouseSq=r,n.dest=r!==n.orig?r:void 0,e.dom.redrawNow()),Ge(e)}})}function Fn(e,n){e.drawable.current&&(e.drawable.current.pos=W(n))}function In(e){const n=e.drawable.current;n&&(n.mouseSq&&Zn(e.drawable,n),Ue(e))}function Ue(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function jn(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Xe(e.drawable))}function Vn(e){var n;const o=(e.shiftKey||e.ctrlKey)&&qe(e),r=e.altKey||e.metaKey||((n=e.getModifierState)===null||n===void 0?void 0:n.call(e,"AltGraph"));return Bn[(o?1:0)+(r?2:0)]}function Zn(e,n){const o=t=>t.orig===n.orig&&t.dest===n.dest,r=e.shapes.find(o);r&&(e.shapes=e.shapes.filter(t=>!o(t))),(!r||r.brush!==n.brush)&&e.shapes.push({orig:n.orig,dest:n.dest,brush:n.brush}),Xe(e)}function Xe(e){e.onChange&&e.onChange(e.shapes)}function Gn(e,n){if(!n.isTrusted||n.button!==void 0&&n.button!==0||n.touches&&n.touches.length>1)return;const o=e.dom.bounds(),r=W(n),t=B(r,w(e),o);if(!t)return;const i=e.pieces.get(t),c=e.selected;!c&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&jn(e),n.cancelable!==!1&&(!n.touches||e.blockTouchScroll||i||c||Un(e,r))&&n.preventDefault();const l=!!e.premovable.current,a=!!e.predroppable.current;e.stats.ctrlKey=n.ctrlKey,e.selected&&ue(e,e.selected,t)?L(d=>re(d,t),e):re(e,t);const s=e.selected===t,g=Qe(e,t);if(i&&g&&s&&qn(e,t)){e.draggable.current={orig:t,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:g,previouslySelected:c,originTarget:n.target,keyHasChanged:!1},g.cgDragging=!0,g.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className=`ghost ${i.color} ${i.role}`,x(d,U(o)(m(t),w(e))),ae(d,!0)),he(e)}else l&&N(e),a&&T(e);e.dom.redraw()}function Un(e,n){const o=w(e),r=e.dom.bounds(),t=Math.pow(r.width/8,2);for(const i of e.pieces.keys()){const c=Oe(i,o,r);if(G(c,n)<=t)return!0}return!1}function Xn(e,n,o,r){const t="a0";e.pieces.set(t,n),e.dom.redraw();const i=W(o);e.draggable.current={orig:t,piece:n,origPos:i,pos:i,started:!0,element:()=>Qe(e,t),originTarget:o.target,newPiece:!0,force:!!r,keyHasChanged:!1},he(e)}function he(e){requestAnimationFrame(()=>{var n;const o=e.draggable.current;if(!o)return;!((n=e.animation.current)===null||n===void 0)&&n.plan.anims.has(o.orig)&&(e.animation.current=void 0);const r=e.pieces.get(o.orig);if(!r||!oe(r,o.piece))X(e);else if(!o.started&&G(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){const i=o.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),o.element=i}const t=e.dom.bounds();x(o.element,[o.pos[0]-t.left-t.width/16,o.pos[1]-t.top-t.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==B(o.pos,w(e),t))}he(e)})}function Yn(e,n){e.draggable.current&&(!n.touches||n.touches.length<2)&&(e.draggable.current.pos=W(n))}function Qn(e,n){const o=e.draggable.current;if(!o)return;if(n.type==="touchend"&&n.cancelable!==!1&&n.preventDefault(),n.type==="touchend"&&o.originTarget!==n.target&&!o.newPiece){e.draggable.current=void 0;return}N(e),T(e);const r=W(n)||o.pos,t=B(r,w(e),e.dom.bounds());t&&o.started&&o.orig!==t?o.newPiece?We(e,o.orig,t,o.force):(e.stats.ctrlKey=n.ctrlKey,Re(e,o.orig,t)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!t&&(e.pieces.delete(o.orig),b(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===t||!t)?M(e):e.selectable.enabled||M(e),Ye(e),e.draggable.current=void 0,e.dom.redraw()}function X(e){const n=e.draggable.current;n&&(n.newPiece&&e.pieces.delete(n.orig),e.draggable.current=void 0,M(e),Ye(e),e.dom.redraw())}function Ye(e){const n=e.dom.elements;n.ghost&&ae(n.ghost,!1)}function Qe(e,n){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===n&&o.tagName==="PIECE")return o;o=o.nextSibling}}function Jn(e,n){e.exploding={stage:1,keys:n},e.dom.redraw(),setTimeout(()=>{ye(e,2),setTimeout(()=>ye(e,void 0),120)},120)}function ye(e,n){e.exploding&&(n?e.exploding.stage=n:e.exploding=void 0,e.dom.redraw())}function eo(e,n){function o(){Pn(e),n()}return{set(r){r.orientation&&r.orientation!==e.orientation&&o(),je(e,r),(r.fen?L:_)(t=>Ve(t,r),e)},state:e,getFen:()=>En(e.pieces),toggleOrientation:o,setPieces(r){L(t=>kn(t,r),e)},selectSquare(r,t){r?L(i=>re(i,r,t),e):e.selected&&(M(e),e.dom.redraw())},move(r,t){L(i=>He(i,r,t),e)},newPiece(r,t){L(i=>de(i,r,t),e)},playPremove(){if(e.premovable.current){if(L(On,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const t=_n(e,r);return e.dom.redraw(),t}return!1},cancelPremove(){_(N,e)},cancelPredrop(){_(T,e)},cancelMove(){_(r=>{pe(r),X(r)},e)},stop(){_(r=>{be(r),X(r)},e)},explode(r){Jn(e,r)},setAutoShapes(r){_(t=>t.drawable.autoShapes=r,e)},setShapes(r){_(t=>t.drawable.shapes=r,e)},getKeyAtDomPos(r){return B(r,w(e),e.dom.bounds())},redrawAll:n,dragNewPiece(r,t,i){Xn(e,r,t,i)},destroy(){be(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function no(){return{pieces:Ie(Fe),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:vn()}}function te(e,n,o){const r=new Map,t=[];for(const l of e)r.set(l.hash,!1);let i=n.firstChild,c;for(;i;)c=i.getAttribute("cgHash"),r.has(c)?r.set(c,!0):t.push(i),i=i.nextSibling;for(const l of t)n.removeChild(l);for(const l of e)r.get(l.hash)||n.appendChild(o(l))}function $(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function oo(e,n,o){const r=e.drawable,t=r.current,i=t&&t.mouseSq?t:void 0,c=new Map,l=e.dom.bounds(),a=r.autoShapes.filter(f=>!f.piece);for(const f of r.shapes.concat(a).concat(i?[i]:[]))f.dest&&c.set(f.dest,(c.get(f.dest)||0)+1);const s=r.shapes.concat(a).map(f=>({shape:f,current:!1,hash:Pe(f,c,!1,l)}));i&&s.push({shape:i,current:!0,hash:Pe(i,c,!0,l)});const g=s.map(f=>f.hash).join(";");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;const d=n.querySelector("defs"),v=n.querySelector("g"),A=o.querySelector("g");ro(r,s,d),te(s.filter(f=>!f.shape.customSvg),v,f=>ke(e,f,r.brushes,c,l)),te(s.filter(f=>f.shape.customSvg),A,f=>ke(e,f,r.brushes,c,l))}function ro(e,n,o){const r=new Map;let t;for(const l of n)l.shape.dest&&(t=e.brushes[l.shape.brush],l.shape.modifiers&&(t=Je(t,l.shape.modifiers)),r.set(t.key,t));const i=new Set;let c=o.firstChild;for(;c;)i.add(c.getAttribute("cgKey")),c=c.nextSibling;for(const[l,a]of r.entries())i.has(l)||o.appendChild(uo(a))}function Pe({orig:e,dest:n,brush:o,piece:r,modifiers:t,customSvg:i},c,l,a){return[a.width,a.height,l,e,n,o,n&&(c.get(n)||0)>1,r&&to(r),t&&io(t),i&&co(i)].filter(s=>s).join(",")}function to(e){return[e.color,e.role,e.scale].filter(n=>n).join(",")}function io(e){return""+(e.lineWidth||"")}function co(e){let n=0;for(let o=0;o<e.length;o++)n=(n<<5)-n+e.charCodeAt(o)>>>0;return"custom-"+n.toString()}function ke(e,{shape:n,current:o,hash:r},t,i,c){let l;const a=Se(m(n.orig),e.orientation);if(n.customSvg)l=lo(n.customSvg,a,c);else if(n.dest){let s=t[n.brush];n.modifiers&&(s=Je(s,n.modifiers)),l=ao(s,a,Se(m(n.dest),e.orientation),o,(i.get(n.dest)||0)>1,c)}else l=so(t[n.brush],a,o,c);return l.setAttribute("cgHash",r),l}function lo(e,n,o){const[r,t]=Y(n,o),i=K($("g"),{transform:`translate(${r},${t})`}),c=K($("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(c),c.innerHTML=e,i}function so(e,n,o,r){const t=Y(n,r),i=fo(),c=(r.width+r.height)/(4*Math.max(r.width,r.height));return K($("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:en(e,o),cx:t[0],cy:t[1],r:c-i[1]/2})}function ao(e,n,o,r,t,i){const c=go(t&&!r),l=Y(n,i),a=Y(o,i),s=a[0]-l[0],g=a[1]-l[1],d=Math.atan2(g,s),v=Math.cos(d)*c,A=Math.sin(d)*c;return K($("line"),{stroke:e.color,"stroke-width":po(e,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:en(e,r),x1:l[0],y1:l[1],x2:a[0]-v,y2:a[1]-A})}function uo(e){const n=K($("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return n.appendChild(K($("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),n.setAttribute("cgKey",e.key),n}function K(e,n){for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&e.setAttribute(o,n[o]);return e}function Se(e,n){return n==="white"?e:[7-e[0],7-e[1]]}function Je(e,n){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(n.lineWidth||e.lineWidth),key:[e.key,n.lineWidth].filter(o=>o).join("")}}function fo(){return[3/64,4/64]}function po(e,n){return(e.lineWidth||10)*(n?.85:1)/64}function en(e,n){return(e.opacity||1)*(n?.9:1)}function go(e){return(e?20:10)/64}function Y(e,n){const o=Math.min(1,n.width/n.height),r=Math.min(1,n.height/n.width);return[(e[0]-3.5)*o,(3.5-e[1])*r]}function ho(e,n){e.innerHTML="",e.classList.add("cg-wrap");for(const a of gn)e.classList.toggle("orientation-"+a,n.orientation===a);e.classList.toggle("manipulable",!n.viewOnly);const o=D("cg-container");e.appendChild(o);const r=D("cg-board");o.appendChild(r);let t,i,c;if(n.drawable.visible&&(t=K($("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),t.appendChild($("defs")),t.appendChild($("g")),i=K($("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild($("g")),c=D("cg-auto-pieces"),o.appendChild(t),o.appendChild(i),o.appendChild(c)),n.coordinates){const a=n.orientation==="black"?" black":"",s=n.ranksPosition==="left"?" left":"";o.appendChild(Ce(ce,"ranks"+a+s)),o.appendChild(Ce(ie,"files"+a))}let l;return n.draggable.enabled&&n.draggable.showGhost&&(l=D("piece","ghost"),ae(l,!1),o.appendChild(l)),{board:r,container:o,wrap:e,ghost:l,svg:t,customSvg:i,autoPieces:c}}function Ce(e,n){const o=D("coords",n);let r;for(const t of e)r=D("coord"),r.textContent=t,o.appendChild(r);return o}function mo(e,n){if(!e.dropmode.active)return;N(e),T(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const r=W(n),t=r&&B(r,w(e),e.dom.bounds());t&&We(e,"a0",t)}e.dom.redraw()}function vo(e,n){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(n).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",t=>t.preventDefault()),e.viewOnly)return;const r=wo(e);o.addEventListener("touchstart",r,{passive:!1}),o.addEventListener("mousedown",r,{passive:!1})}function bo(e,n){const o=[];if("ResizeObserver"in window||o.push(V(document.body,"chessground.resize",n)),!e.viewOnly){const r=Me(e,Yn,Fn),t=Me(e,Qn,In);for(const c of["touchmove","mousemove"])o.push(V(document,c,r));for(const c of["touchend","mouseup"])o.push(V(document,c,t));const i=()=>e.dom.bounds.clear();o.push(V(document,"scroll",i,{capture:!0,passive:!0})),o.push(V(window,"resize",i,{passive:!0}))}return()=>o.forEach(r=>r())}function V(e,n,o,r){return e.addEventListener(n,o,r),()=>e.removeEventListener(n,o,r)}const wo=e=>n=>{e.draggable.current?X(e):e.drawable.current?Ue(e):n.shiftKey||qe(n)?e.drawable.enabled&&zn(e,n):e.viewOnly||(e.dropmode.active?mo(e,n):Gn(e,n))},Me=(e,n,o)=>r=>{e.drawable.current?e.drawable.enabled&&o(e,r):e.viewOnly||n(e,r)};function yo(e){const n=w(e),o=U(e.dom.bounds()),r=e.dom.elements.board,t=e.pieces,i=e.animation.current,c=i?i.plan.anims:new Map,l=i?i.plan.fadings:new Map,a=e.draggable.current,s=ko(e),g=new Set,d=new Set,v=new Map,A=new Map;let f,p,z,q,y,E,I,P,j,F;for(p=r.firstChild;p;){if(f=p.cgKey,nn(p))if(z=t.get(f),y=c.get(f),E=l.get(f),q=p.cgPiece,p.cgDragging&&(!a||a.orig!==f)&&(p.classList.remove("dragging"),x(p,o(m(f),n)),p.cgDragging=!1),!E&&p.cgFading&&(p.cgFading=!1,p.classList.remove("fading")),z){if(y&&p.cgAnimating&&q===Z(z)){const h=m(f);h[0]+=y[2],h[1]+=y[3],p.classList.add("anim"),x(p,o(h,n))}else p.cgAnimating&&(p.cgAnimating=!1,p.classList.remove("anim"),x(p,o(m(f),n)),e.addPieceZIndex&&(p.style.zIndex=ee(m(f),n)));q===Z(z)&&(!E||!p.cgFading)?g.add(f):E&&q===Z(E)?(p.classList.add("fading"),p.cgFading=!0):ne(v,q,p)}else ne(v,q,p);else if(on(p)){const h=p.className;s.get(f)===h?d.add(f):ne(A,h,p)}p=p.nextSibling}for(const[h,H]of s)if(!d.has(h)){j=A.get(H),F=j&&j.pop();const k=o(m(h),n);if(F)F.cgKey=h,x(F,k);else{const u=D("square",H);u.cgKey=h,x(u,k),r.insertBefore(u,r.firstChild)}}for(const[h,H]of t)if(y=c.get(h),!g.has(h))if(I=v.get(Z(H)),P=I&&I.pop(),P){P.cgKey=h,P.cgFading&&(P.classList.remove("fading"),P.cgFading=!1);const k=m(h);e.addPieceZIndex&&(P.style.zIndex=ee(k,n)),y&&(P.cgAnimating=!0,P.classList.add("anim"),k[0]+=y[2],k[1]+=y[3]),x(P,o(k,n))}else{const k=Z(H),u=D("piece",k),S=m(h);u.cgPiece=k,u.cgKey=h,y&&(u.cgAnimating=!0,S[0]+=y[2],S[1]+=y[3]),x(u,o(S,n)),e.addPieceZIndex&&(u.style.zIndex=ee(S,n)),r.appendChild(u)}for(const h of v.values())xe(e,h);for(const h of A.values())xe(e,h)}function Po(e){const n=w(e),o=U(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(nn(r)&&!r.cgAnimating||on(r))&&x(r,o(m(r.cgKey),n)),r=r.nextSibling}function $e(e){var n,o;const r=e.dom.elements.wrap.getBoundingClientRect(),t=e.dom.elements.container,i=r.height/r.width,c=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=c*i;t.style.width=c+"px",t.style.height=l+"px",e.dom.bounds.clear(),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-width",c+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",l+"px")}const nn=e=>e.tagName==="PIECE",on=e=>e.tagName==="SQUARE";function xe(e,n){for(const o of n)e.dom.elements.board.removeChild(o)}function ee(e,n){const r=e[1];return`${n?3+7-r:3+r}`}const Z=e=>`${e.color} ${e.role}`;function ko(e){var n;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const i of e.lastMove)O(o,i,"last-move");if(e.check&&e.highlight.check&&O(o,e.check,"check"),e.selected&&(O(o,e.selected,"selected"),e.movable.showDests)){const i=(n=e.movable.dests)===null||n===void 0?void 0:n.get(e.selected);if(i)for(const l of i)O(o,l,"move-dest"+(e.pieces.has(l)?" oc":""));const c=e.premovable.dests;if(c)for(const l of c)O(o,l,"premove-dest"+(e.pieces.has(l)?" oc":""))}const r=e.premovable.current;if(r)for(const i of r)O(o,i,"current-premove");else e.predroppable.current&&O(o,e.predroppable.current.key,"current-premove");const t=e.exploding;if(t)for(const i of t.keys)O(o,i,"exploding"+t.stage);return o}function O(e,n,o){const r=e.get(n);r?e.set(n,`${r} ${o}`):e.set(n,o)}function ne(e,n,o){const r=e.get(n);r?r.push(o):e.set(n,[o])}function So(e,n){const r=e.drawable.autoShapes.filter(t=>t.piece).map(t=>({shape:t,hash:$o(t),current:!1}));te(r,n,t=>Mo(e,t,e.dom.bounds()))}function Co(e){var n;const o=w(e),r=U(e.dom.bounds());let t=(n=e.dom.elements.autoPieces)===null||n===void 0?void 0:n.firstChild;for(;t;)De(t,r(m(t.cgKey),o),t.cgScale),t=t.nextSibling}function Mo(e,{shape:n,hash:o},r){var t,i,c;const l=n.orig,a=(t=n.piece)===null||t===void 0?void 0:t.role,s=(i=n.piece)===null||i===void 0?void 0:i.color,g=(c=n.piece)===null||c===void 0?void 0:c.scale,d=D("piece",`${a} ${s}`);return d.setAttribute("cgHash",o),d.cgKey=l,d.cgScale=g,De(d,U(r)(m(l),w(e)),g),d}const $o=e=>{var n,o,r;return[e.orig,(n=e.piece)===null||n===void 0?void 0:n.role,(o=e.piece)===null||o===void 0?void 0:o.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function xo(e,n){const o=no();Ve(o,n||{});function r(){const t="dom"in o?o.dom.unbind:void 0,i=ho(e,o),c=mn(()=>i.board.getBoundingClientRect()),l=g=>{yo(s),i.autoPieces&&So(s,i.autoPieces),!g&&i.svg&&oo(s,i.svg,i.customSvg)},a=()=>{$e(s),Po(s),i.autoPieces&&Co(s)},s=o;return s.dom={elements:i,bounds:c,redraw:Ao(l),redrawNow:l,unbind:t},s.drawable.prevSvgHash="",$e(s),l(!1),vo(s,a),t||(s.dom.unbind=bo(s,a)),s.events.insert&&s.events.insert(i),s}return eo(r(),r)}function Ao(e){let n=!1;return()=>{n||(n=!0,requestAnimationFrame(()=>{e(),n=!1}))}}function Do(e){let n;return{c(){n=sn("div"),this.h()},l(o){n=an(o,"DIV",{id:!0,class:!0}),dn(n).forEach(me),this.h()},h(){ve(n,"id","chessground"),ve(n,"class","svelte-tnw5ty")},m(o,r){un(o,n,r),e[22](n)},p:Q,i:Q,o:Q,d(o){o&&me(n),e[22](null)}}}function qo(e,n,o){let{config:r={}}=n,t,i;fn(async()=>{i=xo(t,r)});function c(u){i.set(u)}function l(){return i.state}function a(){return i.getFen()}function s(){return i.toggleOrientation()}function g(u,S){return i.move(u,S)}function d(u){return i.setPieces(u)}function v(u,S){return i.selectSquare(u,S)}function A(u,S){return i.newPiece(u,S)}function f(){return i.playPremove()}function p(){i.cancelPremove()}function z(u){return i.playPredrop(u)}function q(){i.cancelPredrop()}function y(){i.cancelMove()}function E(){i.stop()}function I(u){i.explode(u)}function P(u){i.setShapes(u)}function j(u){i.setAutoShapes(u)}function F(){return i.redrawAll()}function h(u,S,rn){i.dragNewPiece(u,S,rn)}function H(){return i.destroy()}function k(u){pn[u?"unshift":"push"](()=>{t=u,o(0,t)})}return e.$$set=u=>{"config"in u&&o(1,r=u.config)},[t,r,c,l,a,s,g,d,v,A,f,p,z,q,y,E,I,P,j,F,h,H,k]}class _o extends tn{constructor(n){super(),cn(this,n,qo,Do,ln,{config:1,set:2,getState:3,getFen:4,toggleOrientation:5,move:6,setPieces:7,selectSquare:8,newPiece:9,playPremove:10,cancelPremove:11,playPredrop:12,cancelPredrop:13,cancelMove:14,stop:15,explode:16,setShapes:17,setAutoShapes:18,redrawAll:19,dragNewPiece:20,destroy:21})}get set(){return this.$$.ctx[2]}get getState(){return this.$$.ctx[3]}get getFen(){return this.$$.ctx[4]}get toggleOrientation(){return this.$$.ctx[5]}get move(){return this.$$.ctx[6]}get setPieces(){return this.$$.ctx[7]}get selectSquare(){return this.$$.ctx[8]}get newPiece(){return this.$$.ctx[9]}get playPremove(){return this.$$.ctx[10]}get cancelPremove(){return this.$$.ctx[11]}get playPredrop(){return this.$$.ctx[12]}get cancelPredrop(){return this.$$.ctx[13]}get cancelMove(){return this.$$.ctx[14]}get stop(){return this.$$.ctx[15]}get explode(){return this.$$.ctx[16]}get setShapes(){return this.$$.ctx[17]}get setAutoShapes(){return this.$$.ctx[18]}get redrawAll(){return this.$$.ctx[19]}get dragNewPiece(){return this.$$.ctx[20]}get destroy(){return this.$$.ctx[21]}}export{_o as C};
